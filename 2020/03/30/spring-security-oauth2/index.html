<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="spring-security-oauth2"><meta name="keywords" content=""><meta name="author" content="GwangHui Park"><meta name="copyright" content="GwangHui Park"><title>spring-security-oauth2 | Gwang Story</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-security-oauth2-vs-spring-security"><span class="toc-number">1.</span> <span class="toc-text"> Spring-Security-oauth2 vs Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#clientregistration"><span class="toc-number">1.1.</span> <span class="toc-text"> ClientRegistration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clientregistrationrepository"><span class="toc-number">1.2.</span> <span class="toc-text"> ClientRegistrationRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauthauthorizedclient"><span class="toc-number">1.3.</span> <span class="toc-text"> OAuthAuthorizedClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizedclientrepository"><span class="toc-number">1.4.</span> <span class="toc-text"> OAuth2AuthorizedClientRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#authenticationtrustresolver"><span class="toc-number">1.5.</span> <span class="toc-text"> AuthenticationTrustResolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizedclientservice"><span class="toc-number">1.6.</span> <span class="toc-text"> OAuth2AuthorizedClientService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizedclientmanager"><span class="toc-number">1.7.</span> <span class="toc-text"> OAuth2AuthorizedClientManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizedclientprovider"><span class="toc-number">1.8.</span> <span class="toc-text"> OAuth2AuthorizedClientProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizationrequestredirectfilter"><span class="toc-number">1.9.</span> <span class="toc-text"> OAuth2AuthorizationRequestRedirectFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2authorizationcodegrantfilter"><span class="toc-number">1.10.</span> <span class="toc-text"> OAuth2AuthorizationCodeGrantFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#authorizationredirectstrategy-defaultredirectstrategy"><span class="toc-number">1.11.</span> <span class="toc-text"> authorizationRedirectStrategy : DefaultRedirectStrategy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defaultoauth2authorizationrequestresolver"><span class="toc-number">1.12.</span> <span class="toc-text"> DefaultOauth2AuthorizationRequestResolver</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">GwangHui Park</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">100</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">47</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">12</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Gwang Story</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">spring-security-oauth2</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-30</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="spring-security-oauth2-vs-spring-security"><a class="markdownIt-Anchor" href="#spring-security-oauth2-vs-spring-security"></a> Spring-Security-oauth2 vs Spring Security</h2>
<ul>
<li>Group ID Spring Security 안의 ArtifactID로 oauth2로 이관되면서 Group ID가 security-oauth2 였던 OSS가 Deprecated 되었다.</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  thymeleaf:</span></span><br><span class="line"><span class="attr">    cache:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    oauth2:</span></span><br><span class="line"><span class="attr">      client:</span></span><br><span class="line"><span class="attr">        registration:</span></span><br><span class="line"><span class="attr">          messaging-client-auth-code:</span></span><br><span class="line"><span class="attr">            provider:</span> <span class="string">keycloak</span></span><br><span class="line"><span class="attr">            client-id:</span> <span class="string">messaging-client</span></span><br><span class="line"><span class="attr">            client-secret:</span> <span class="string">secret</span></span><br><span class="line"><span class="attr">            authorization-grant-type:</span> <span class="string">authorization_code</span></span><br><span class="line"><span class="attr">            redirect-uri:</span> <span class="string">"&#123;baseUrl&#125;/authorized"</span></span><br><span class="line"><span class="attr">            scope:</span> <span class="string">message.read,message.write</span></span><br><span class="line"><span class="attr">          messaging-client-client-creds:</span></span><br><span class="line"><span class="attr">            provider:</span> <span class="string">keycloak</span></span><br><span class="line"><span class="attr">            client-id:</span> <span class="string">messaging-client</span></span><br><span class="line"><span class="attr">            client-secret:</span> <span class="string">secret</span></span><br><span class="line"><span class="attr">            authorization-grant-type:</span> <span class="string">client_credentials</span></span><br><span class="line"><span class="attr">            scope:</span> <span class="string">message.read,message.write</span></span><br><span class="line"><span class="attr">          messaging-client-password:</span></span><br><span class="line"><span class="attr">            provider:</span> <span class="string">keycloak</span></span><br><span class="line"><span class="attr">            client-id:</span> <span class="string">messaging-client</span></span><br><span class="line"><span class="attr">            client-secret:</span> <span class="string">secret</span></span><br><span class="line"><span class="attr">            authorization-grant-type:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">            scope:</span> <span class="string">message.read,message.write</span></span><br><span class="line"><span class="attr">        provider:</span></span><br><span class="line"><span class="attr">          keycloak:</span></span><br><span class="line"><span class="attr">            authorization-uri:</span> <span class="attr">http://localhost:8090/auth/realms/oauth2-sample/protocol/openid-connect/auth</span></span><br><span class="line"><span class="attr">            token-uri:</span> <span class="attr">http://localhost:8090/auth/realms/oauth2-sample/protocol/openid-connect/token</span></span><br></pre></td></tr></table></figure>
<h3 id="clientregistration"><a class="markdownIt-Anchor" href="#clientregistration"></a> ClientRegistration</h3>
<ul>
<li>Oauth 2.0 or OpenID Connect 1.0 Provider 들에 등록된 Client의 정보들을 적게된다.</li>
<li>client 정보에는 ID, Secret, authorization grant type, redirect URL… etc</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientRegistration</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line">	<span class="keyword">private</span> String registrationId;</span><br><span class="line">	<span class="keyword">private</span> String clientId;</span><br><span class="line">	<span class="keyword">private</span> String clientSecret;</span><br><span class="line">	<span class="keyword">private</span> ClientAuthenticationMethod clientAuthenticationMethod = ClientAuthenticationMethod.BASIC;</span><br><span class="line">	<span class="keyword">private</span> AuthorizationGrantType authorizationGrantType;</span><br><span class="line">	<span class="keyword">private</span> String redirectUriTemplate;</span><br><span class="line">	<span class="keyword">private</span> Set&lt;String&gt; scopes = Collections.emptySet();</span><br><span class="line">	<span class="keyword">private</span> ProviderDetails providerDetails = <span class="keyword">new</span> ProviderDetails();</span><br><span class="line">	<span class="keyword">private</span> String clientName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderDetails</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line">        <span class="keyword">private</span> String authorizationUri;</span><br><span class="line">        <span class="keyword">private</span> String tokenUri;</span><br><span class="line">        <span class="keyword">private</span> UserInfoEndpoint userInfoEndpoint = <span class="keyword">new</span> UserInfoEndpoint();</span><br><span class="line">        <span class="keyword">private</span> String jwkSetUri;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, Object&gt; configurationMetadata = Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>registrationId: The ID that uniquely identifies the ClientRegistration.</li>
<li>clientId: The client identifier.</li>
<li>clientSecret: The client secret.</li>
<li>clientAuthenticationMethod: The method used to authenticate the Client with the Provider. The supported values are basic, post and none (public clients).</li>
<li>authorizationGrantType: The OAuth 2.0 Authorization Framework defines four Authorization Grant types. The supported values are authorization_code, client_credentials and password.</li>
<li>redirectUriTemplate: The client’s registered redirect URI that the Authorization Server redirects the end-user’s user-agent to after the end-user has authenticated and authorized access to the client.</li>
<li>scopes: The scope(s) requested by the client during the Authorization Request flow, such as openid, email, or profile.</li>
<li>clientName: A descriptive name used for the client. The name may be used in certain scenarios, such as when displaying the name of the client in the auto-generated login page.</li>
<li>authorizationUri: The Authorization Endpoint URI for the Authorization Server.</li>
<li>tokenUri: The Token Endpoint URI for the Authorization Server.</li>
<li>jwkSetUri: The URI used to retrieve the JSON Web Key (JWK) Set from the Authorization Server, which contains the cryptographic key(s) used to verify the JSON Web Signature (JWS) of the ID Token and optionally the UserInfo Response.</li>
<li>configurationMetadata: The OpenID Provider Configuration Information. This information will only be available if the Spring Boot 2.x property spring.security.oauth2.client.provider.[providerId].issuerUri is configured.</li>
<li>(userInfoEndpoint)uri: The UserInfo Endpoint URI used to access the claims/attributes of the authenticated end-user.</li>
<li>(userInfoEndpoint)authenticationMethod: The authentication method used when sending the access token to the UserInfo Endpoint. The supported values are header, form and query.</li>
<li>userNameAttributeName: The name of the attribute returned in the UserInfo Response that references the Name or Identifier of the end-user.</li>
</ol>
<blockquote>
<p>Endpoint 별 초기화</p>
<blockquote>
<p>OpenID Connect Provider : configuration endpoint<br />
OAuth2.0 : Metadata endpoint</p>
</blockquote>
</blockquote>
<h3 id="clientregistrationrepository"><a class="markdownIt-Anchor" href="#clientregistrationrepository"></a> ClientRegistrationRepository</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryClientRegistrationRepository</span> <span class="keyword">implements</span> <span class="title">ClientRegistrationRepository</span>, <span class="title">Iterable</span>&lt;<span class="title">ClientRegistration</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ClientRegistration&gt; registrations;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ClientRegistration <span class="title">findByRegistrationId</span><span class="params">(String registrationId)</span> </span>&#123;</span><br><span class="line">		Assert.hasText(registrationId, <span class="string">"registrationId cannot be empty"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.registrations.get(registrationId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Default 구현체는 InMemoryClientRegistrationRepository 이다.</li>
<li>Map으로 ClientRegistration 들을 가지고 있으며, 해당 registrationId 로 ClientRegistration을 찾을수 있는 기능을 제공한다.</li>
<li>Spring boot 2.x auto-configuration은 spring.security.oauth2.client.registration.[registrationId] 의 형태로 바인드를 자동으로 해놓는다.</li>
<li>또한 ClientRegistrationRepository라는 이름으로 Bean 등록을 해놓았기 때문에 Inject 받아서 사용가능하다.</li>
</ul>
<h3 id="oauthauthorizedclient"><a class="markdownIt-Anchor" href="#oauthauthorizedclient"></a> OAuthAuthorizedClient</h3>
<ul>
<li>Authorized Client를 표현한다.</li>
<li>Authorized Client는 보호되는 자원에 대한 Access 권한을 받은 것으로 간주된다.</li>
<li>Oauth2AuthorizedClient 는 ClientRegistration과 Resource Owner(End-user) 간 OAuth2AccessToken, OAuth2RefreshToken을 연결시켜준다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2AuthorizedClient</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientRegistration clientRegistration;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String principalName;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OAuth2AccessToken accessToken;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OAuth2RefreshToken refreshToken;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="oauth2authorizedclientrepository"><a class="markdownIt-Anchor" href="#oauth2authorizedclientrepository"></a> OAuth2AuthorizedClientRepository</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticatedPrincipalOAuth2AuthorizedClientRepository</span> <span class="keyword">implements</span> <span class="title">OAuth2AuthorizedClientRepository</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AuthenticationTrustResolver authenticationTrustResolver = <span class="keyword">new</span> AuthenticationTrustResolverImpl();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OAuth2AuthorizedClientService authorizedClientService;</span><br><span class="line">	<span class="keyword">private</span> OAuth2AuthorizedClientRepository anonymousAuthorizedClientRepository = <span class="keyword">new</span> HttpSessionOAuth2AuthorizedClientRepository();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T extends OAuth2AuthorizedClient&gt; <span class="function">T <span class="title">loadAuthorizedClient</span><span class="params">(String clientRegistrationId, Authentication principal,</span></span></span><br><span class="line"><span class="function"><span class="params">																		HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.isPrincipalAuthenticated(principal)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.authorizedClientService.loadAuthorizedClient(clientRegistrationId, principal.getName());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.anonymousAuthorizedClientRepository.loadAuthorizedClient(clientRegistrationId, principal, request);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAuthorizedClient</span><span class="params">(OAuth2AuthorizedClient authorizedClient, Authentication principal,</span></span></span><br><span class="line"><span class="function"><span class="params">										HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.isPrincipalAuthenticated(principal)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.authorizedClientService.saveAuthorizedClient(authorizedClient, principal);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.anonymousAuthorizedClientRepository.saveAuthorizedClient(authorizedClient, principal, request, response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAuthorizedClient</span><span class="params">(String clientRegistrationId, Authentication principal,</span></span></span><br><span class="line"><span class="function"><span class="params">										HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.isPrincipalAuthenticated(principal)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.authorizedClientService.removeAuthorizedClient(clientRegistrationId, principal.getName());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.anonymousAuthorizedClientRepository.removeAuthorizedClient(clientRegistrationId, principal, request, response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPrincipalAuthenticated</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> authentication != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">				!<span class="keyword">this</span>.authenticationTrustResolver.isAnonymous(authentication) &amp;&amp;</span><br><span class="line">				authentication.isAuthenticated();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>AuthenticationTrustResolver에 질의해 인증된 사용자라면 service에 요청하고 아니면 anonymousAuthorizedClientRepository에 요청한다.</li>
<li>OAuth2AuthorizationCodeAuthenticationToken으로 인증을 진행한다.</li>
<li>Session Attribute Name = org.springframework.security.oauth2.client.web.HttpSessionOAuth2AuthorizedClientRepository.AUTHORIZED_CLIENTS</li>
<li>내부에 anonymousAuthorizedClientRepository로 HttpSessionOAuth2AuthorizedClientRepository을 가지고 있다.</li>
<li>해당 Session Attribute Name으로 AuthorizedClient들을 저장하고 있다.</li>
</ul>
<h3 id="authenticationtrustresolver"><a class="markdownIt-Anchor" href="#authenticationtrustresolver"></a> AuthenticationTrustResolver</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationTrustResolverImpl</span> <span class="keyword">implements</span> <span class="title">AuthenticationTrustResolver</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;? extends Authentication&gt; anonymousClass = AnonymousAuthenticationToken.class;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;? extends Authentication&gt; rememberMeClass = RememberMeAuthenticationToken.class;</span><br><span class="line"></span><br><span class="line">	Class&lt;? extends Authentication&gt; getAnonymousClass() &#123;</span><br><span class="line">		<span class="keyword">return</span> anonymousClass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;? extends Authentication&gt; getRememberMeClass() &#123;</span><br><span class="line">		<span class="keyword">return</span> rememberMeClass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAnonymous</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ((anonymousClass == <span class="keyword">null</span>) || (authentication == <span class="keyword">null</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> anonymousClass.isAssignableFrom(authentication.getClass());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRememberMe</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ((rememberMeClass == <span class="keyword">null</span>) || (authentication == <span class="keyword">null</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> rememberMeClass.isAssignableFrom(authentication.getClass());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnonymousClass</span><span class="params">(Class&lt;? extends Authentication&gt; anonymousClass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.anonymousClass = anonymousClass;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRememberMeClass</span><span class="params">(Class&lt;? extends Authentication&gt; rememberMeClass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.rememberMeClass = rememberMeClass;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Anonymous, RememberMe 를 구현하고 할당이 가능한지에 따라 True, False를 반환한다.</li>
</ul>
<h3 id="oauth2authorizedclientservice"><a class="markdownIt-Anchor" href="#oauth2authorizedclientservice"></a> OAuth2AuthorizedClientService</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryOAuth2AuthorizedClientService</span> <span class="keyword">implements</span> <span class="title">OAuth2AuthorizedClientService</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;OAuth2AuthorizedClientId, OAuth2AuthorizedClient&gt; authorizedClients;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">InMemoryOAuth2AuthorizedClientService</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(clientRegistrationRepository, <span class="string">"clientRegistrationRepository cannot be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class="line">		<span class="keyword">this</span>.authorizedClients = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">InMemoryOAuth2AuthorizedClientService</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">													Map&lt;OAuth2AuthorizedClientId, OAuth2AuthorizedClient&gt; authorizedClients)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(clientRegistrationRepository, <span class="string">"clientRegistrationRepository cannot be null"</span>);</span><br><span class="line">		Assert.notEmpty(authorizedClients, <span class="string">"authorizedClients cannot be empty"</span>);</span><br><span class="line">		<span class="keyword">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class="line">		<span class="keyword">this</span>.authorizedClients = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(authorizedClients);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="keyword">public</span> &lt;T extends OAuth2AuthorizedClient&gt; <span class="function">T <span class="title">loadAuthorizedClient</span><span class="params">(String clientRegistrationId, String principalName)</span> </span>&#123;</span><br><span class="line">		Assert.hasText(clientRegistrationId, <span class="string">"clientRegistrationId cannot be empty"</span>);</span><br><span class="line">		Assert.hasText(principalName, <span class="string">"principalName cannot be empty"</span>);</span><br><span class="line">		ClientRegistration registration = <span class="keyword">this</span>.clientRegistrationRepository.findByRegistrationId(clientRegistrationId);</span><br><span class="line">		<span class="keyword">if</span> (registration == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (T) <span class="keyword">this</span>.authorizedClients.get(<span class="keyword">new</span> OAuth2AuthorizedClientId(clientRegistrationId, principalName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAuthorizedClient</span><span class="params">(OAuth2AuthorizedClient authorizedClient, Authentication principal)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(authorizedClient, <span class="string">"authorizedClient cannot be null"</span>);</span><br><span class="line">		Assert.notNull(principal, <span class="string">"principal cannot be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.authorizedClients.put(<span class="keyword">new</span> OAuth2AuthorizedClientId(authorizedClient.getClientRegistration().getRegistrationId(),</span><br><span class="line">				principal.getName()), authorizedClient);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAuthorizedClient</span><span class="params">(String clientRegistrationId, String principalName)</span> </span>&#123;</span><br><span class="line">		Assert.hasText(clientRegistrationId, <span class="string">"clientRegistrationId cannot be empty"</span>);</span><br><span class="line">		Assert.hasText(principalName, <span class="string">"principalName cannot be empty"</span>);</span><br><span class="line">		ClientRegistration registration = <span class="keyword">this</span>.clientRegistrationRepository.findByRegistrationId(clientRegistrationId);</span><br><span class="line">		<span class="keyword">if</span> (registration != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.authorizedClients.remove(<span class="keyword">new</span> OAuth2AuthorizedClientId(clientRegistrationId, principalName));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ClientRegistrationRepository를 가지고 있고, 해당 Repository에 CRUD를 하는 기능들을 가지고 있다.</li>
<li>Bean으로 선언되어 있어 Application레벨에서 사용이 용이하게 되어있다.</li>
</ul>
<h3 id="oauth2authorizedclientmanager"><a class="markdownIt-Anchor" href="#oauth2authorizedclientmanager"></a> OAuth2AuthorizedClientManager</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultOAuth2AuthorizedClientManager</span> <span class="keyword">implements</span> <span class="title">OAuth2AuthorizedClientManager</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OAuth2AuthorizedClientRepository authorizedClientRepository;</span><br><span class="line">	<span class="keyword">private</span> OAuth2AuthorizedClientProvider authorizedClientProvider = context -&gt; <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> Function&lt;OAuth2AuthorizeRequest, Map&lt;String, Object&gt;&gt; contextAttributesMapper = <span class="keyword">new</span> DefaultContextAttributesMapper();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OAuth2AuthorizedClient <span class="title">authorize</span><span class="params">(OAuth2AuthorizeRequest authorizeRequest)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(authorizeRequest, <span class="string">"authorizeRequest cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">		String clientRegistrationId = authorizeRequest.getClientRegistrationId();</span><br><span class="line">		OAuth2AuthorizedClient authorizedClient = authorizeRequest.getAuthorizedClient();</span><br><span class="line">		Authentication principal = authorizeRequest.getPrincipal();</span><br><span class="line"></span><br><span class="line">		HttpServletRequest servletRequest = getHttpServletRequestOrDefault(authorizeRequest.getAttributes());</span><br><span class="line">		Assert.notNull(servletRequest, <span class="string">"servletRequest cannot be null"</span>);</span><br><span class="line">		HttpServletResponse servletResponse = getHttpServletResponseOrDefault(authorizeRequest.getAttributes());</span><br><span class="line">		Assert.notNull(servletResponse, <span class="string">"servletResponse cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">		OAuth2AuthorizationContext.Builder contextBuilder;</span><br><span class="line">		<span class="keyword">if</span> (authorizedClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">			contextBuilder = OAuth2AuthorizationContext.withAuthorizedClient(authorizedClient);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ClientRegistration clientRegistration = <span class="keyword">this</span>.clientRegistrationRepository.findByRegistrationId(clientRegistrationId);</span><br><span class="line">			Assert.notNull(clientRegistration, <span class="string">"Could not find ClientRegistration with id '"</span> + clientRegistrationId + <span class="string">"'"</span>);</span><br><span class="line">			authorizedClient = <span class="keyword">this</span>.authorizedClientRepository.loadAuthorizedClient(</span><br><span class="line">					clientRegistrationId, principal, servletRequest);</span><br><span class="line">			<span class="keyword">if</span> (authorizedClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">				contextBuilder = OAuth2AuthorizationContext.withAuthorizedClient(authorizedClient);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				contextBuilder = OAuth2AuthorizationContext.withClientRegistration(clientRegistration);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		OAuth2AuthorizationContext authorizationContext = contextBuilder</span><br><span class="line">				.principal(principal)</span><br><span class="line">				.attributes(attributes -&gt; &#123;</span><br><span class="line">					Map&lt;String, Object&gt; contextAttributes = <span class="keyword">this</span>.contextAttributesMapper.apply(authorizeRequest);</span><br><span class="line">					<span class="keyword">if</span> (!CollectionUtils.isEmpty(contextAttributes)) &#123;</span><br><span class="line">						attributes.putAll(contextAttributes);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;)</span><br><span class="line">				.build();</span><br><span class="line"></span><br><span class="line">		authorizedClient = <span class="keyword">this</span>.authorizedClientProvider.authorize(authorizationContext);</span><br><span class="line">		<span class="keyword">if</span> (authorizedClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.authorizedClientRepository.saveAuthorizedClient(authorizedClient, principal, servletRequest, servletResponse);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// In the case of re-authorization, the returned `authorizedClient` may be null if re-authorization is not supported.</span></span><br><span class="line">			<span class="comment">// For these cases, return the provided `authorizationContext.authorizedClient`.</span></span><br><span class="line">			<span class="keyword">if</span> (authorizationContext.getAuthorizedClient() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> authorizationContext.getAuthorizedClient();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> authorizedClient;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>내부에 ClientRegistrationRepository로는 InMemoryClientRegistrationRepository를 가지고 있다.</li>
<li>내부에 AuthorizedClientRepository로 AuthenticatedPrincipalOAuth2AuthorizedClientRepository를 가지고 있다.</li>
<li>내부에 AuthenticationProvider로 DelegatingOAuth2AuthorizedClientProvider를 가지고 있다.
<ul>
<li>DelegatingOAuth2AuthorizedClientProvider는 Config에서 선언한 GrantType에 해당하는 Provider들을 전부 가지고 있다.</li>
</ul>
</li>
<li>The DefaultOAuth2AuthorizedClientManager is designed to be used within the context of a HttpServletRequest.<br />
When operating outside of a HttpServletRequest context, use AuthorizedClientServiceOAuth2AuthorizedClientManager instead.</li>
</ul>
<h3 id="oauth2authorizedclientprovider"><a class="markdownIt-Anchor" href="#oauth2authorizedclientprovider"></a> OAuth2AuthorizedClientProvider</h3>
<ul>
<li>각 GrantType에 따른 인증 방식이 들어있다.</li>
<li>인증을 하는 조건이 맞지 않으면 Throw Exception을 던진다.</li>
</ul>
<h3 id="oauth2authorizationrequestredirectfilter"><a class="markdownIt-Anchor" href="#oauth2authorizationrequestredirectfilter"></a> OAuth2AuthorizationRequestRedirectFilter</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2AuthorizationRequestRedirectFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_AUTHORIZATION_REQUEST_BASE_URI = <span class="string">"/oauth2/authorization"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ThrowableAnalyzer throwableAnalyzer = <span class="keyword">new</span> DefaultThrowableAnalyzer();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RedirectStrategy authorizationRedirectStrategy = <span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line">	<span class="keyword">private</span> OAuth2AuthorizationRequestResolver authorizationRequestResolver;</span><br><span class="line">	<span class="keyword">private</span> AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; authorizationRequestRepository =</span><br><span class="line">		<span class="keyword">new</span> HttpSessionOAuth2AuthorizationRequestRepository();</span><br><span class="line">	<span class="keyword">private</span> RequestCache requestCache = <span class="keyword">new</span> HttpSessionRequestCache();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OAuth2AuthorizationRequestRedirectFilter</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(clientRegistrationRepository, DEFAULT_AUTHORIZATION_REQUEST_BASE_URI);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OAuth2AuthorizationRequestRedirectFilter</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository, String authorizationRequestBaseUri)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(clientRegistrationRepository, <span class="string">"clientRegistrationRepository cannot be null"</span>);</span><br><span class="line">		Assert.hasText(authorizationRequestBaseUri, <span class="string">"authorizationRequestBaseUri cannot be empty"</span>);</span><br><span class="line">		<span class="keyword">this</span>.authorizationRequestResolver = <span class="keyword">new</span> DefaultOAuth2AuthorizationRequestResolver(</span><br><span class="line">				clientRegistrationRepository, authorizationRequestBaseUri);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OAuth2AuthorizationRequestRedirectFilter</span><span class="params">(OAuth2AuthorizationRequestResolver authorizationRequestResolver)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(authorizationRequestResolver, <span class="string">"authorizationRequestResolver cannot be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.authorizationRequestResolver = authorizationRequestResolver;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAuthorizationRequestRepository</span><span class="params">(AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; authorizationRequestRepository)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(authorizationRequestRepository, <span class="string">"authorizationRequestRepository cannot be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.authorizationRequestRepository = authorizationRequestRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRequestCache</span><span class="params">(RequestCache requestCache)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(requestCache, <span class="string">"requestCache cannot be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.requestCache = requestCache;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			OAuth2AuthorizationRequest authorizationRequest = <span class="keyword">this</span>.authorizationRequestResolver.resolve(request);</span><br><span class="line">			<span class="keyword">if</span> (authorizationRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">this</span>.sendRedirectForAuthorization(request, response, authorizationRequest);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception failed) &#123;</span><br><span class="line">			<span class="keyword">this</span>.unsuccessfulRedirectForAuthorization(request, response, failed);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			filterChain.doFilter(request, response);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="comment">// Check to see if we need to handle ClientAuthorizationRequiredException</span></span><br><span class="line">			Throwable[] causeChain = <span class="keyword">this</span>.throwableAnalyzer.determineCauseChain(ex);</span><br><span class="line">			ClientAuthorizationRequiredException authzEx = (ClientAuthorizationRequiredException) <span class="keyword">this</span>.throwableAnalyzer</span><br><span class="line">				.getFirstThrowableOfType(ClientAuthorizationRequiredException.class, causeChain);</span><br><span class="line">			<span class="keyword">if</span> (authzEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					OAuth2AuthorizationRequest authorizationRequest = <span class="keyword">this</span>.authorizationRequestResolver.resolve(request, authzEx.getClientRegistrationId());</span><br><span class="line">					<span class="keyword">if</span> (authorizationRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="keyword">throw</span> authzEx;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">this</span>.sendRedirectForAuthorization(request, response, authorizationRequest);</span><br><span class="line">					<span class="keyword">this</span>.requestCache.saveRequest(request, response);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception failed) &#123;</span><br><span class="line">					<span class="keyword">this</span>.unsuccessfulRedirectForAuthorization(request, response, failed);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">				<span class="keyword">throw</span> (ServletException) ex;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">				<span class="keyword">throw</span> (RuntimeException) ex;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendRedirectForAuthorization</span><span class="params">(HttpServletRequest request, HttpServletResponse response, OAuth2AuthorizationRequest authorizationRequest)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (AuthorizationGrantType.AUTHORIZATION_CODE.equals(authorizationRequest.getGrantType())) &#123;</span><br><span class="line">			<span class="keyword">this</span>.authorizationRequestRepository.saveAuthorizationRequest(authorizationRequest, request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.authorizationRedirectStrategy.sendRedirect(request, response, authorizationRequest.getAuthorizationRequestUri());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsuccessfulRedirectForAuthorization</span><span class="params">(HttpServletRequest request, HttpServletResponse response,	Exception failed)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">			logger.error(<span class="string">"Authorization Request failed: "</span> + failed.toString(), failed);</span><br><span class="line">		&#125;</span><br><span class="line">		response.sendError(HttpStatus.INTERNAL_SERVER_ERROR.value(), HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThrowableAnalyzer</span> <span class="keyword">extends</span> <span class="title">ThrowableAnalyzer</span> </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initExtractorMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>.initExtractorMap();</span><br><span class="line">			registerExtractor(ServletException.class, throwable -&gt; &#123;</span><br><span class="line">				ThrowableAnalyzer.verifyThrowableHierarchy(throwable, ServletException.class);</span><br><span class="line">				<span class="keyword">return</span> ((ServletException) throwable).getRootCause();</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="oauth2authorizationcodegrantfilter"><a class="markdownIt-Anchor" href="#oauth2authorizationcodegrantfilter"></a> OAuth2AuthorizationCodeGrantFilter</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0. WebAsyncManagerIntegrationFilter </span><br><span class="line">1. SecurityContextPersistenceFilter@6814 </span><br><span class="line">2. HeaderWriterFilter</span><br><span class="line">3. CsrfFilter</span><br><span class="line">4. LogoutFilter </span><br><span class="line"></span><br><span class="line">5. OAuth2AuthorizationRequestRedirectFilter </span><br><span class="line"></span><br><span class="line">6. UsernamePasswordAuthenticationFilter </span><br><span class="line">7. RequestCacheAwareFilter </span><br><span class="line">8. SecurityContextHolderAwareRequestFilter </span><br><span class="line">9. AnonymousAuthenticationFilter </span><br><span class="line"></span><br><span class="line">10. OAuth2AuthorizationCodeGrantFilter </span><br><span class="line"></span><br><span class="line">11. SessionManagementFilter </span><br><span class="line">12. ExceptionTranslationFilter </span><br><span class="line">13. FilterSecurityInterceptor</span><br></pre></td></tr></table></figure>
<h3 id="authorizationredirectstrategy-defaultredirectstrategy"><a class="markdownIt-Anchor" href="#authorizationredirectstrategy-defaultredirectstrategy"></a> authorizationRedirectStrategy : DefaultRedirectStrategy</h3>
<h3 id="defaultoauth2authorizationrequestresolver"><a class="markdownIt-Anchor" href="#defaultoauth2authorizationrequestresolver"></a> DefaultOauth2AuthorizationRequestResolver</h3>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">GwangHui Park</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.devkwang.app/2020/03/30/spring-security-oauth2/">https://blog.devkwang.app/2020/03/30/spring-security-oauth2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/30/Spring-annotation/"><i class="fa fa-chevron-left">  </i><span>Spring-annotation</span></a></div><div class="next-post pull-right"><a href="/2020/03/26/java-map-marker/"><span>java-map-marker</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By GwangHui Park</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>